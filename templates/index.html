<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Microstructure Ladder</title>
    <!-- Lightweight Charts for Price Chart with Fallback -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js" 
            onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.1.1/lightweight-charts.standalone.production.min.js';"></script>
    <link rel="stylesheet" href="/static/style.css?v=3">
</head>
<body>
    <div id="error-banner"></div>

    <div class="layout-grid">
        <!-- Left Column: Ladder -->
        <div class="container">
            <div class="intro-box">
                <div class="intro-title">
                    <span>BTC/USDT Microstructure</span>
                    <div class="status-container">
                        <span id="status-indicator" class="status-dot status-disconnected"></span>
                        <span id="status-text" class="status-tooltip">Disconnected</span>
                    </div>
                </div>
                <div>
                    Advanced order book visualization. 
                    <strong>OFI</strong> (Order Flow Imbalance) predicts short-term pressure.
                    <strong>Microprice</strong> shows the volume-weighted "true" price.
                    <strong>CVD</strong> (Cumulative Volume Delta) shows aggressive buyer/seller dominance.
                </div>
            </div>

            <!-- New Insights Section -->
            <div class="intro-box" style="background: #1c2128; border-color: #444c56;">
                <div class="intro-title" style="color: #58a6ff;">Real-Time Insights</div>
                <div id="insights-text" style="font-size: 13px; white-space: pre-line;">Waiting for data...</div>
            </div>
        
            <div class="header-grid">
                <div class="metric-box">
                    <div class="metric-label" data-tooltip="Best Ask - Best Bid. The cost of immediate execution.">Spread</div>
                    <div id="spread" class="metric-value">--</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label" data-tooltip="(Bid + Ask) / 2. The simple middle price.">Mid Price</div>
                    <div id="mid" class="metric-value">--</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label" data-tooltip="Volume-weighted Mid Price. Pulls towards the side with less liquidity (more likely to move there).">Microprice</div>
                    <div id="micro" class="metric-value" style="color: #e3b341;">--</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label" data-tooltip="Order Book Imbalance [-1, 1]. Positive = Buy Pressure (More Bid Vol).">Imbalance</div>
                    <div id="imb" class="metric-value">--</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label" data-tooltip="Order Flow Imbalance (Rolling). Net flow of limit orders adding pressure. >0 Buy, <0 Sell.">OFI (50)</div>
                    <div id="ofi" class="metric-value">--</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label" data-tooltip="Cumulative Volume Delta. Net buying (taker) volume since start.">CVD</div>
                    <div id="cvd" class="metric-value">--</div>
                </div>
            </div>

            <div class="imbalance-section">
                <div class="imbalance-label">
                    <span>Sell Pressure</span>
                    <span>Buy Pressure</span>
                </div>
                <div class="imbalance-container">
                    <div id="imb-bar" class="imbalance-bar"></div>
                </div>
            </div>

            <div id="ladder" class="ladder">
                <div class="ladder-header">
                    <div class="header-cell price">Price</div>
                    <div class="header-cell size">Size</div>
                    <div class="header-cell total">Visual Depth</div>
                </div>
                <div id="asks-container"></div>
                <div class="spread-divider" id="spread-info">--</div>
                <div id="bids-container"></div>
            </div>
        </div>

        <!-- Right Column: Charts -->
        <div class="viz-column">
            <div class="chart-container">
                <div class="chart-title">
                    Price Divergence
                    <span style="font-weight: normal; color: #8b949e;">Blue: Mid | Yellow: Micro</span>
                </div>
                <div id="price-chart"></div>
            </div>
            
            <div class="heatmap-container">
                <div class="chart-title">Limit Order Heatmap (Depth History)</div>
                <canvas id="heatmap-canvas"></canvas>
                
                <div class="heatmap-legend">
                    <div class="legend-item"><div class="color-box ask"></div> Ask (Resistance)</div>
                    <div class="legend-item">← Past (20s) | Present →</div>
                    <div class="legend-item"><div class="color-box bid"></div> Bid (Support)</div>
                </div>
                
                <div class="heatmap-explainer">
                    <strong>How to read:</strong> The Heatmap shows the evolution of the Order Book over time.
                    <br>• <strong>X-Axis:</strong> Time. Newest data enters from the right.
                    <br>• <strong>Y-Axis:</strong> Price. Centered on the current Mid Price.
                    <br>• <strong>Brightness:</strong> Intensity represents volume size. Brighter = stronger wall.
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js?v=3"></script>
</body>
</html>
